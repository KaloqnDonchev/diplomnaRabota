<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="style.css">
        <title>Document</title>

        <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    </head>
    <body>
        <div id="header"></div>
        <div class="search">
            <div id="header"></div>
            <button id="admin-button" class="styled-button">Admin dashboard</button>
            <button id="download-button" class="styled-button">Download all pictures</button>
            <button id="home-button" class="styled-button">Home</button>
            <input type="text">
            <div class="searchbutton styled-button">Search</div>
            <button  class="styled-button"><a href="/logout" id="logout-button">Logout</a></button>
        </div>
        <div id="gallery" class="gallery"></div>
        <div class="next">More photos</div>
    </body>

    <script>
        const apiAuth = "563492ad6f91700001000001c08b1dc33dd44cb6a722ea328554b1f0";
        const next = document.querySelector(".next");
        const input = document.querySelector("input");
        const searchbutton = document.querySelector(".searchbutton");
        let pageNumber = 1;
        let search = false;
        let query = "";

        $(function(){
            $("#header").load("header.html"); 
        });

        function parseJwt (token) {
            var base64Url = token.split('.')[1];
            var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            var jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));

            return JSON.parse(jsonPayload);
        };
        
        async function downloadImage(imageSrc) {
            const image = await fetch(imageSrc)
            const imageBlog = await image.blob()
            const imageURL = URL.createObjectURL(imageBlog)

            const link = document.createElement('a')
            link.href = imageURL
            link.download = 'image file name here'
            document.body.appendChild(link)
            link.click()
            document.body.removeChild(link)
        }

        async function curatedPhotos(pageNumber) {
            const data = await fetch(`https://api.pexels.com/v1/curated?per_page=15&page=${pageNumber}`, {
                method:"GET",
                headers: {
                    Accept: "application/json",
                    Authorization: apiAuth,
                } 
            });
            const result = await data.json();
            result.photos.forEach((photo) => {
                const pic = document.createElement("div");
                pic.className = "image-box";
                pic.innerHTML = `<img src=${photo.src.large} class="photo"> <input value="${photo.src.large}" class="checkbox" type="checkbox" checked>`;
                document.querySelector(".gallery").appendChild(pic);
            });
        };

        async function searchPhotos(query, pageNumber) {
            const data = await fetch(`https://api.pexels.com/v1/search?query=${query}&per_page=15&page=${pageNumber}`, {
                method:"GET",
                headers: {
                    Accept: "application/json",
                    Authorization: apiAuth,
                } 
            });
            const result = await data.json();
            result.photos.forEach((photo) => {
                const pic = document.createElement("div");
                pic.innerHTML = `<img src=${photo.src.large}> <input value="${photo.src.large}" class="checkbox" type="checkbox" checked>`;
                document.querySelector(".gallery").appendChild(pic);
            });
        };

        function clear() {
            input.value = "";
            document.querySelector(".gallery").innerHTML = "";
            pageNumber = 1;
        }


        input.addEventListener("input", (event) => {
            event.preventDefault();
            query = event.target.value;
        });


        searchbutton.addEventListener("click", () =>{
            if(input.value === "") return;
            clear();
            search = true;
            searchPhotos(query, pageNumber);
            pageNumber++;
        });


        next.addEventListener("click", (e) => {
            if (!search) {
                pageNumber++;
                curatedPhotos(pageNumber);
            } else {
                if(query.value === "") return;
                pageNumber++;
                searchPhotos(query, pageNumber);
            }
        });

        homeButton = document.getElementById("home-button");
        homeButton.addEventListener('click', (e) => {
            e.preventDefault();
            location.reload();
        })

        function forceDownload(url, fileName){
            var xhr = new XMLHttpRequest();
            xhr.open("GET", url, true);
            xhr.responseType = "blob";
            xhr.onload = function(){
                var urlCreator = window.URL || window.webkitURL;
                var imageUrl = urlCreator.createObjectURL(this.response);
                var tag = document.createElement('a');
                tag.href = imageUrl;
                tag.download = fileName;
                document.body.appendChild(tag);
                tag.click();
                document.body.removeChild(tag);
            }
            xhr.send();
        }

        const downloadButton = document.getElementById("download-button");
        downloadButton.addEventListener('click', (e) => {
            e.preventDefault();
            const photos = document.getElementsByClassName("photo");
            const photosUrl = [];
            // const booleanFirstCheckbox = photos[0].nextSibling.nextSibling.checked;           // checkbox implementation work in progess
            for (let photo of photos) {
                photosUrl.push(photo.src);
            };
            for (let photo of photos) {
                forceDownload(photo.src,"xd");
            }

        })

        const adminButton = document.getElementById("admin-button");
        adminButton.addEventListener('click', (e) => {
            e.preventDefault();
            const jwtToken = localStorage.getItem('token');
            if (parseJwt(jwtToken).username === "admin@admin") {
                window.location.href = "/admin-dashboard.html";
            } else {
                alert("You do not have permission");
            }
        })


        curatedPhotos(pageNumber);

    </script>
</html>